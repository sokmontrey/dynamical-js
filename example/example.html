<html>
	<head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Example</title>

        <!-- CodeMirror CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">

        <!-- Prism.js CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism.min.css" integrity="sha512-/mZ1FHPkg6EKcxo0fKXF51ak6Cr2ocgDi5ytaTBjsQZIH/RNs6GF6+oId/vPe3eJB836T36nXwVh/WBl/cWT4w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <!-- CodeMirror and Prism.js libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/javascript/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>

        <!--Codemirror theme-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/nord.min.css" integrity="sha512-sPc4jmw78pt6HyMiyrEt3QgURcNRk091l3dZ9M309x4wM2QwnCI7bUtsLnnWXqwBMECE5YZTqV6qCDwmC2FMVA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/gruvbox-dark.min.css" integrity="sha512-FLFAEkNiUCQXE4MNOd7SrEzeNFEhiCnNYsa1S3sNMZDTNFJgPy42giNLGGJ+Rjbce5L6ICJXtlv6Ue61FFIqqw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <script src="https://cdn.tailwindcss.com"></script>

        <script src="https://kit.fontawesome.com/b71972c7cc.js" crossorigin="anonymous"></script>
        
		<style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
        :root{
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            --background-color: #252323;
            --accent-color: #F45D01;
            --secondary-color: #188EDC;
            --button-color: var(--accent-color);
            --button-shadow-color: rgba(0, 0, 0, 0.1);
            --font-color: #D6D6B1;
            --dark-font-color: var(--background-color);
            --panel-color: #393636;
        }
        body{
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .CodeMirror{
            flex: 1;
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
            width: 100%;
            border-radius: 0.5rem;
            padding-top: 1rem;
        }
        .CodeMirror-scroll {
            overflow-y: scroll;
            overflow-x: auto;
        }
        button{
            transition: all ease-in-out 0.1s;
        }
        button:hover{
            transform: translate(0,-0.3rem);
            box-shadow: 0 0.5rem 1rem var(--button-shadow-color);
            color: var(--accent-color);
        }
        button:active{
            transform: translate(0,0rem);
        }
        select{
            outline: none;
            transition: all ease-in-out 0.3s;
        }
		</style>
	</head>
	<body>
        <div class='
            flex justify-center items-stretch
            w-[100%] h-[calc(100vh-2rem)]
            '>

            <div class='
                flex flex-col justify-stretch 
                flex-1
                '>
                <div class='
                    flex items-center justify-between
                    bg-[var(--panel-color)]
                    mb-3
                    rounded-lg
                    '>
                    <div class='
                        flex items-center justify-start
                        text-[var(--dark-font-color)]
                        rounded-lg
                        '>
                        <a href='../index.html'>
                            <button class='
                                p-2 px-4
                                bg-[var(--accent-color)]
                                rounded-lg
                                hover:text-[var(--font-color)]
                                '>
                                Dynamical
                            </button>
                        </a>
                        <a href='https://github.com/sokmontrey/dynamical-js'>
                            <button class='
                                py-2 mx-5
                                rounded
                                text-[var(--font-color)]
                                hover:text-[var(--secondary-color)]
                                '>
                                <i class="fa-brands fa-github"></i>
                                GitHub
                            </button>
                        </a>
                    </div>
                    <div class='
                        flex items-center justify-end
                        '>
                        <select id='example-selector' class='
                            bg-[transparent] text-[var(--font-color)]
                            hover:text-[var(--accent-color)]
                            '>
                        </select>

                        <button id='reload-button' class='
                            text-[var(--font-color)]
                            px-5 py-2 mx-5
                            rounded
                            '>
                            <!--RELOAD-->
                            <i class="fa-solid fa-rotate-right"></i>
                        </button>
                    </div>
                </div>

                <div name="editor" id="editor-container"
                class='contents'>
                    <textarea id="editor">
                    </textarea>
                </div>
            </div>

            <iframe id='iframe' class="flex-[0.7] mr-5" scrolling="no">
            </iframe>
        </div>

        <script>

            const examples = {
                'cloth (experiment)':
`//NOTE: This is just an experimentation with the library
import { Vector } from '../src/util/dynamical_vector.js';
import PointMass from '../src/point_mass.js';
import Renderer from '../src/renderer.js';
import { Constraint } from '../src/constraint.js';
import Composite from '../src/composite.js';

const canvas = document.getElementById('canvas');

const renderer = new Renderer(canvas);
renderer.setBackground('#252323');

const space = 10;

const cloth = new Composite();

for(let i=0; i<30; i++){
    for(let j=0; j<20; j++){
        const point = PointMass.create(
            (i * space) + 100, (j * space) + 100
        ).setName(\`\${i}-\${j}\`);

        if(j == 0) point.static();

        cloth.addPointMass(point);

        if(j != 0){
            cloth.connect(\`\${i}-\${j}\`, \`\${i}-\${j-1}\`, 0.05)
        }

        if(i != 0){
            cloth.connect(\`\${i}-\${j}\`, \`\${i-1}-\${j}\`, 0.05);
        }
    }
}

const points = cloth._points;

const m_pos = points['29-19'].position;
let is_follow = false;
canvas.addEventListener("mousemove", function (evt) {
    var mousePos = getMousePos(canvas, evt);
    m_pos.x = mousePos.x 
    m_pos.y = mousePos.y
}, false);

canvas.addEventListener("mousedown", ()=> is_follow = true);
canvas.addEventListener("mouseup", ()=> is_follow = false);

function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}
renderer.update((delta_time)=>{
    renderer.clear();

    if(is_follow){
        points['29-19'].setPosition(m_pos);
        points['29-19'].setOldPosition(m_pos);
    }

    for(let i=0; i<10; i++){
        cloth.update(delta_time * 0.1);
    }

    const connections = cloth._connections;
    for(let i=0; i<connections.length; i++){
        const points = connections[i].getPoints();
        const r = i/connections.length;
        renderer.line({
            start: points[0].position,
            end: points[1].position,
            line_width: 0.9
        }).setStrokeStyle(\`rgb(
            \${r * 255}, 
            \${150}, 
            \${129})\`).stroke();
    }
});
`,
                'brigde': 
`
//TODO: Explainations
import { Vector } from '../src/util/dynamical_vector.js';
import PointMass from '../src/point_mass.js';
import Renderer from '../src/renderer.js';
import { Constraint } from '../src/constraint.js';

const canvas = document.getElementById('canvas');

const renderer = new Renderer(canvas);
renderer.setBackground('#252323');

const s = 150;
const points = [
    PointMass.create(250-s/2  , 250-s/3),
    PointMass.create(250+s/2  , 250-s/3),

    PointMass.create(250-2*s/2, 250+s/3).static(),
    PointMass.create(250      , 250+s/3),
    PointMass.create(250+2*s/2, 250+s/3).static(),

    PointMass.create(250+2*s/3, 250+s/3)
];

const connections = [
    Constraint.create('rigid').setPointMass(points[2], points[0]),
    Constraint.create('rigid').setPointMass(points[0], points[1]),
    Constraint.create('rigid').setPointMass(points[1], points[4]),

    Constraint.create('rigid').setPointMass(points[2], points[3]),
    Constraint.create('rigid').setPointMass(points[3], points[4]),

    Constraint.create('rigid').setPointMass(points[0], points[3]),
    Constraint.create('rigid').setPointMass(points[3], points[1]),

    Constraint.create('rigid').setPointMass(points[3], points[5]),
];

renderer.update((delta_time)=>{
    renderer.clear();
    
    for(let i in points){
        points[i].applyGravity();
    }
    for(let iter=0; iter<3; iter++){
        for(let i in points){
            points[i].updatePosition(delta_time*0.6);
        }
        for(let i in connections){
            connections[i].check();
        }
    }

    for(let each_connection of connections){
        const points = each_connection.getPoints();
        for(let j=1; j<points.length; j++){
            const stress = each_connection.getStress(j-1);
            renderer.line({
                start: points[j].position,
                end: points[j-1].position,
                line_width: 5
            }).setStrokeStyle(\`rgb(\${stress * 500}, 63, 63)\`).stroke();
        }
    }

    for(let i in points){
        renderer.circle({
            position: points[i].position,
            radius: 8
        }).setFillStyle('#188edc').fill();
    }
});
`,
                'point-mass': 
`import { Vector } from '../src/util/dynamical_vector.js';
import PointMass from '../src/point_mass.js';
import Renderer from '../src/renderer.js';
import { Constraint } from '../src/constraint.js';

/* Get canvas element */
const canvas = document.getElementById('canvas');

/* create a new renderer object */
const renderer = new Renderer(canvas);
renderer.setBackground('#252323');

/* create a point mass with the initial position at the center */
/* point mass take Vector as the argument for its initial position*/
const point_mass = PointMass.create(250,250);

/* 
    Create a container constraint for the scence
    The constraint is given the point_mass created to keep track of.
    The default width and height of the container is 500
*/
const container = Constraint.create('rectangle_container');

/* LOOP */
renderer.update((delta_time)=>{
    // clear the canvas at the start of every frame.
    renderer.clear();

    /* 
        apply gravity (0, 9.8)
        position y value is down due to the canvas coordinating system
    */
    point_mass.applyGravity(new Vector(0, 9.8));

    /* 
        Update the position of the point_mass with renderer's delta_time
        The point_mass will update its position using Verlet integration method 
    */
    point_mass.updatePosition(delta_time);

    /*
        Call the check method on constraint
    */
    container.check(point_mass);

    /* 
        Visualize the position of point_mass 
        point_mass does not have any real geometrical properties
        It is just a 0D point
        But we draw as a circle with the radius of 10 to visualize it
    */
    renderer.circle({
        position: point_mass.position, 
        radius: 6, 
    }).setFillStyle('#D6D6B1').fill();

    /* Visualize the container*/
    renderer.setStrokeStyle('#D6D6B1');
    for(let i=1; i<container.getVertices().length; i++){
        renderer.line({
            start: container.getVertex(i-1), 
            end: container.getVertex(i), 
        }).stroke();
    }

    renderer.line({
        start: container.getVertex(container.getVertices().length-1), 
        end: container.getVertex(0), 
    }).stroke();
});
`,
            };

            /*
                essential part for running example/user generated code
            */
            //get iframe element
            const iframe = document.getElementById('iframe');
            iframe.src = './visual.html';

            iframe.addEventListener('load', function(){
                const iframe_win = iframe.contentWindow;
                const iframe_doc = iframe.contentDocument;

                //create a div container for the script element
                const script_container = iframe_doc.getElementById('script-container');

                function runCode(code){
                    /*
                        clear the container
                        create a new script element
                        put the new code into the script element
                        put the script element back to the script container
                    */
                    const script_ele = iframe_doc.createElement('script');
                    script_ele.type = 'module';
                    script_ele.innerHTML = code;

                    script_container.innerHTML = '';
                    script_container.appendChild(script_ele);
                }

                /*
                    text editor
                */
                const editor = document.getElementById("editor");
                const cm = CodeMirror.fromTextArea(editor, {
                    mode: "javascript",
                    lineNumbers: true,
                    viewportMargin: Infinity,
                    theme: "gruvbox-dark",
                });
                cm.highlighter = function(text, options) {
                    return Prism.highlight(text, Prism.languages.javascript, 'javascript');
                };

                function renderCode(code){
                    cm.setValue(code);
                }
                function getEditorCode(){
                    return cm.getValue();
                }

                /*
                    run the code from the EDITOR
                    when the reload button is clicked
                */
                document.getElementById('reload-button')
                    .addEventListener('click', function(){
                        runCode(getEditorCode());
                    });

                /*
                    Mechanism for select and rerender different examples
                */
                const selector = document.getElementById('example-selector');

                //List all the examples available
                for(let example_name in examples){
                    selector.innerHTML += `<option value='${example_name}'>
    ${example_name}
    </option>`
                }

                function getSelectorValue(){
                    return selector.value;
                }

                //rerender and run code with the selector is changed
                selector.addEventListener('change', function(e){
                    renderCode(examples[getSelectorValue()]);
                    runCode(examples[getSelectorValue()]);
                });

                /*
                    render and run the default example in the selector
                */
                renderCode(examples[getSelectorValue()]);
                runCode(examples[getSelectorValue()]);
            });
        </script>
	</body>
</html>
