<html>
	<head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Example</title>

        <!-- Include the CodeMirror CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">

        <!-- Include the Prism.js CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism.min.css" integrity="sha512-/mZ1FHPkg6EKcxo0fKXF51ak6Cr2ocgDi5ytaTBjsQZIH/RNs6GF6+oId/vPe3eJB836T36nXwVh/WBl/cWT4w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <!-- Include the CodeMirror and Prism.js libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/javascript/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>

        <!--Codemirror theme-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/nord.min.css" integrity="sha512-sPc4jmw78pt6HyMiyrEt3QgURcNRk091l3dZ9M309x4wM2QwnCI7bUtsLnnWXqwBMECE5YZTqV6qCDwmC2FMVA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <script src="https://cdn.tailwindcss.com"></script>

		<style>
            @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
			body{
				padding-top: 2rem;
				background-color: #2E3440;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
			}
			canvas{
                border-image: linear-gradient(#2E3440, #ffffff) 0.5;
                border-width: 1.5px;
                border-style: solid;
			}
            .CodeMirror{
                font-size: 13px;
                font-family: 'JetBrains Mono', monospace;
                height: 80vh;
            }
            .CodeMirror-scroll {
                width: 50vw;
                overflow-y: scroll;
                overflow-x: scroll;
            }
            button{
                transition: all ease-in-out 0.3s;
            }
            select{
                outline: none;
                transition: all ease-in-out 0.3s;
            }
		</style>
	</head>
	<body>
        <div class="
        fixed bottom-0 right-0
        p-2
        ">
            <p style="font-family: 'JetBrains Mono'" 
            class="
            text-sm text-white
            ">Developed by Sokmontrey Sythat. 
                <a target="_blank" href="https://github.com/sokmontrey/dynamical-js"
                class="text-blue-400 underline">GitHub</a>
            </p>
        </div>

		<p class="
        text-white text-lg 
        ">Dynamical JS</p>

        <div class="
        flex space-x-6 justify-center
        mb-10
        text-white
        w-[10vw]
        ">
            <a href="/">Home</a>
            <a class="text-[#88C0D0]">Example</a>
            <a href="/about.html">About</a>
        </div>

        <div>
            <div class="flex">
                <div>
                    <canvas class="m-5 w-[30vw] h-[30vw]"></canvas>

                    <div class="flex">
                        <button id="render-button" 
                        class="
                        text-[#2E3440] bg-[#A3BE8C]
                        font-bold 
                        hover:px-5 hover:py-3 
                        px-4 py-2 ml-5 rounded
                        ">Render</button>

                        <select id="select" class="
                        text-white bg-transparent
                        px-5 mx-5
                        font-bold
                        rounded
                        hover:text-[#88C0D0]
                        ">
                        </select>

                        <div class="
                        text-[#88C0D0]
                        font-bold 
                        px-4 py-2 ml-5 rounded
                        ">
                            <input class="
                            w-[1.1rem] h-[1.1rem]
                            rounded
                            "
                            type="checkbox" id="show-code-checkbox"/>

                            <label class="
                            pl-2
                            ">Code</label>
                        </div>
                    </div>
                </div>

                <div name="editor" id="editor-container">
                    <textarea id="editor">
                    </textarea>
                </div>

            </div>
        </div>

        <script type="module">
            import Renderer from '../src/renderer.js';
            import { Vector2 } from '../src/util/vector.js';
            import PointMass from '../src/point_mass.js';
            import { DistanceConstraint, BoxConstraint, SpringConstraint } from '../src/constraint.js';

            const examples = {
"bridge": `
const renderer = new Renderer(canvas[0]);
renderer.setBackground('#2E3440');

const l = 150;

const p1 = [
	new PointMass(renderer.CENTER.add(new Vector2(-l/2, -l/3))),
	new PointMass(renderer.CENTER.add(new Vector2(l/2, -l/3))),
];

const p2 = [
	new PointMass(renderer.CENTER.add(new Vector2(-l, l/3)), {is_static: true}),
	new PointMass(renderer.CENTER.add(new Vector2(0, l/3))),
	new PointMass(renderer.CENTER.add(new Vector2(l, l/3)), {is_static: true}),
];

const P = new PointMass(renderer.CENTER.add(new Vector2(l/1.2, l/3)));

const r1 = new DistanceConstraint([p2[0], p1[0], p2[1], p1[1], p2[2]], {record_tension: true});
const r2 = new DistanceConstraint([p2[0], p2[1], p2[2]], {record_tension: true});
const r3 = new DistanceConstraint([p1[0], p1[1]], {record_tension: true});
const r4 = new DistanceConstraint([p2[1], P], {record_tension: true});

const canvas_container = new BoxConstraint( renderer.WIDTH, renderer.HEIGHT, []);

renderer.update(({delta_time, context:c})=>{
	renderer.clear();

    delta_time *= 0.55

  	for(let i=0; i<p1.length; i++){
    	p1[i].applyGravity(0, 9.8);
    }
  	p2[1].applyForce(new Vector2(0, 9.8));
  	P.applyGravity(0, 9.8);
  
    for(let iteration=0; iteration<4; iteration++){
        r1.check();
        r2.check();
        r3.check();
        r4.check();
        for(let i=0; i<p1.length;i++){
            p1[i].updatePosition(delta_time);
        }
        p2[1].updatePosition(delta_time);
        P.updatePosition(delta_time);
    }
  
    const all_constraint = [...r1.getConstraint(), 
        ...r2.getConstraint(), 
        ...r3.getConstraint(), 
        ...r4.getConstraint()
    ];
    for(let each of all_constraint){
        renderer.line(each.point1.position, each.point2.position, 
        5, 
        {stroke: \`rgb(\${each.tension * 191}, 97, 106)\`})
    }

  	c.fillStyle = '#EBCB8B';
  	for(let i=0; i<p1.length; i++){
    	renderer.point(p1[i].position, 10);
    }
  	for(let i=0; i<p2.length; i++){
    	renderer.point(p2[i].position, 10);
    }
  	renderer.point(P.position, 10);
  
}); `,
"square bridge": `

const renderer = new Renderer(canvas[0]);
renderer.setBackground('#2E3440');

const l = 150;

const p1 = [
	new PointMass(renderer.CENTER.add(new Vector2(-l/2, -l/3))),
	new PointMass(renderer.CENTER.add(new Vector2(0, -l/3))),
	new PointMass(renderer.CENTER.add(new Vector2(l/2, -l/3))),
];

const p2 = [
	new PointMass(renderer.CENTER.add(new Vector2(-l, l/3)), {is_static: true}),
	new PointMass(renderer.CENTER.add(new Vector2(-l/2, l/3))),
  	new PointMass(renderer.CENTER.add(new Vector2(0, l/3))),
	new PointMass(renderer.CENTER.add(new Vector2(l/2, l/3))),
	new PointMass(renderer.CENTER.add(new Vector2(l, l/3)), {is_static: true}),
];

const P = new PointMass(renderer.CENTER.add(new Vector2(l/1.2, l/3)));

const r1 = new DistanceConstraint([p2[0], p1[0], p1[1], p1[2], p2[4]], {record_tension: true});
const r2 = new DistanceConstraint([p2[0], p2[1], p2[2], p2[3], p2[4]], {record_tension: true});
const r3 = new DistanceConstraint([p1[0], p2[1]], {record_tension: true});
const r4 = new DistanceConstraint([p1[1], p2[2]], {record_tension: true});
const r5 = new DistanceConstraint([p1[2], p2[3]], {record_tension: true});
const r6 = new DistanceConstraint([p2[2], P], {record_tension: true});

const canvas_container = new BoxConstraint( renderer.WIDTH, renderer.HEIGHT, []);

renderer.update(({delta_time, context:c})=>{
	renderer.clear();

    delta_time *= 0.55

  	for(let i=0; i<p1.length; i++){
    	p1[i].applyGravity(0, 9.8);
    }
  	for(let i=0; i<p2.length; i++){
    	p2[i].applyGravity(0, 9.8);
    }
  	P.applyGravity(0, 9.8);
  
    for(let iteration=0; iteration<4; iteration++){
        r1.check();
        r2.check();
        r3.check();
        r4.check();
      	r5.check();
      	r6.check();
        for(let i=0; i<p1.length;i++){
            p1[i].updatePosition(delta_time);
        }
        for(let i=0; i<p2.length;i++){
            p2[i].updatePosition(delta_time);
        }
        P.updatePosition(delta_time);
    }
  
    const all_constraint = [...r1.getConstraint(), 
                            ...r2.getConstraint(), 
                            ...r3.getConstraint(), 
                            ...r4.getConstraint(), 
                            ...r5.getConstraint(),
                           	...r6.getConstraint()
                           ];
    for(let each of all_constraint){
        renderer.line(each.point1.position, each.point2.position, 
        5, 
        {stroke: \`rgb(\${each.tension * 191}, 97, 106)\`})
    }

  	c.fillStyle = '#EBCB8B';
  	for(let i=0; i<p1.length; i++){
    	renderer.point(p1[i].position, 10);
    }
  	for(let i=0; i<p2.length; i++){
    	renderer.point(p2[i].position, 10);
    }
  	renderer.point(P.position, 10);
  
}); 
`,
"cube": `
const renderer = new Renderer(canvas[0]);
renderer.setBackground('#2E3440');

const square = [
    new PointMass(renderer.CENTER.add(new Vector2(0, -100))),
    new PointMass(renderer.CENTER.add(new Vector2(100,0))),
    new PointMass(renderer.CENTER.add(new Vector2(0, 100))),
    new PointMass(renderer.CENTER.add(new Vector2(-100, 0))),
];
const square_structure = new DistanceConstraint([...square, square[0], square[2]]);

const canvas_container = new BoxConstraint( renderer.WIDTH, renderer.HEIGHT, square);

renderer.update(({delta_time, context:c})=>{
    renderer.clear();

    for(let i=0; i<square.length; i++){
        square[i].applyGravity(0, 9.8);
    }


    for(let iteration=0; iteration<4; iteration++){
        square_structure.check();
        canvas_container.check();
        for(let i=0; i<square.length; i++){
            square[i].updatePosition(delta_time*0.55);
        }
    }

    renderer.polygon(square, {fill:"#D08770"});
});
`,
};

            const select_ele = document.getElementById('select');
            for(let name in examples){
                select_ele.innerHTML = select_ele.innerHTML 
                + `<option>${name}</option>`;
            }

            const canvas = document.getElementsByTagName('canvas');

            const editor = document.getElementById("editor");
            const cm = CodeMirror.fromTextArea(editor, {
                mode: "javascript",
                lineNumbers: true,
                viewportMargin: Infinity,
                theme: "nord",
            });
            cm.highlighter = function(text, options) {
                return Prism.highlight(text, Prism.languages.javascript, 'javascript');
            };

            cm.setValue(examples[select_ele.value]);
            render();

            select_ele.addEventListener('change', (e)=>{
                cm.setValue(examples[e.target.value]);
                render();
            });

            document.getElementById('render-button').addEventListener('click', ()=>{
                render();
            });

            checkboxChanged();
            document.getElementById('show-code-checkbox').addEventListener('change', (e)=>{
                checkboxChanged();
            });
            function checkboxChanged(){
                const checked = document.getElementById('show-code-checkbox').checked;
                document.getElementById('editor-container').style = `display: ${checked ? 'block':'none'};`;
            }

            function render(){
                eval(cm.getValue());
            }
        </script>

	</body>
</html>
