<html>
	<head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Example</title>

        <!-- Include the CodeMirror CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">

        <!-- Include the Prism.js CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism.min.css" integrity="sha512-/mZ1FHPkg6EKcxo0fKXF51ak6Cr2ocgDi5ytaTBjsQZIH/RNs6GF6+oId/vPe3eJB836T36nXwVh/WBl/cWT4w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <!-- Include the CodeMirror and Prism.js libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/javascript/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>

        <!--Codemirror theme-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/nord.min.css" integrity="sha512-sPc4jmw78pt6HyMiyrEt3QgURcNRk091l3dZ9M309x4wM2QwnCI7bUtsLnnWXqwBMECE5YZTqV6qCDwmC2FMVA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <script src="https://cdn.tailwindcss.com"></script>

		<style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
        :root{
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            --background-color: #191716;
            --accent-color: #0DA;
            --secondary-color: #06B;
            --button-color: var(--accent-color);
            --button-shadow-color: rgba(3, 161, 108, 0.4);
            --font-color: white;
            --dark-font-color: var(--background-color);
            --panel-color: #302d2b;
        }
        body{
            background-color: var(--background-color);

            padding-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .CodeMirror{
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
            height: 80vh;
        }
        .CodeMirror-scroll {
            overflow-y: scroll;
            overflow-x: auto;
        }
        button{
            transition: all ease-in-out 0.1s;
        }
        button:hover{
            transform: translate(0,-0.3rem);
            box-shadow: 0 0.5rem 1rem var(--button-shadow-color);
        }
        button:active{
            transform: translate(0,0rem);
        }
        select{
            outline: none;
            transition: all ease-in-out 0.3s;
        }
		</style>
	</head>
	<body>
        <div class="
        fixed bottom-0 right-0
        p-2
        ">
            <p style="font-family: 'JetBrains Mono'" 
            class="
            text-sm text-white
            ">Developed by Sokmontrey Sythat. 
                <a target="_blank" href="https://github.com/sokmontrey/dynamical-js"
                class="text-blue-400 underline">GitHub</a>
            </p>
        </div>

        <div name="editor" id="editor-container">
            <textarea id="editor">
            </textarea>
        </div>

        <button id='reload-button' class='text-white'>Reload</button>
        <select id='example-selector' class=''></select>

        <iframe id='iframe'
        class="
        w-[100%]
        h-[100vh]
        "> </iframe>

        <script>

            const examples = {
'example1': 
`import { Vector2 } from '../src/util/dynamical_vector.js';
import PointMass from '../src/point_mass.js';
import Renderer from '../src/renderer.js';

const canvas = document.getElementById('canvas');
const renderer = new Renderer(canvas);
`,
            }

            /*
                essential part for running example/user generated code
            */
            //get iframe element
            const iframe = document.getElementById('iframe');
            const iframe_win = iframe.contentWindow;
            const iframe_doc = iframe.contentDocument;

            //inject a canvas element to the iframe
            const canvas = iframe_doc.createElement('canvas');
            canvas.id = 'canvas';
            iframe_doc.body.appendChild(canvas);

            //create a div container for the script element
            const script_container = iframe_doc.createElement('div');
            iframe_doc.body.appendChild(script_container);

            function runCode(code){
                /*
                    clear the container
                    create a new script element
                    put the new code into the script element
                    put the script element back to the script container
                */
                const script_ele = iframe_doc.createElement('script');
                script_ele.type = 'module';
                script_ele.innerHTML = code;

                script_container.innerHTML = '';
                script_container.appendChild(script_ele);
            }

            /*
                text editor
            */
            const editor = document.getElementById("editor");
            const cm = CodeMirror.fromTextArea(editor, {
                mode: "javascript",
                lineNumbers: true,
                viewportMargin: Infinity,
                theme: "nord",
            });
            cm.highlighter = function(text, options) {
                return Prism.highlight(text, Prism.languages.javascript, 'javascript');
            };

            function renderCode(code){
                cm.setValue(code);
            }
            function getEditorCode(){
                return cm.getValue();
            }

            /*
                run the code from the EDITOR
                when the reload button is clicked
            */
            document.getElementById('reload-button')
                .addEventListener('click', function(){
                    runCode(getEditorCode());
                });

            /*
                Mechanism for select and rerender different examples
            */
            const selector = document.getElementById('example-selector');

            //List all the examples available
            for(let example_name in examples){
                selector.innerHTML += `<option value='${example_name}'>
${example_name}
</option>`
            }

            function getSelectorValue(){
                return selector.value;
            }

            //rerender and run code with the selector is changed
            selector.addEventListener('change', function(e){
                renderCode(examples[getSelectorValue()]);
                runCode(examples[getSelectorValue()]);
            });

            /*
                render and run the default example in the selector
            */
            renderCode(examples[getSelectorValue()]);
            runCode(examples[getSelectorValue()]);
        </script>
	</body>
</html>
