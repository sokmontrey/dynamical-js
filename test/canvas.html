<html>
  <head>
    <meta charset="utf-8" />
    <title>Canvas</title>
  </head>
  <body>
    <canvas width="500" height="500" id="canvas"></canvas>
    <script type="module">
      import { Renderer, Vector } from "../index.js";

      const canvas = document.getElementById("canvas");
      const renderer = new Renderer(canvas);
      renderer.setFillColor("black");

      class PointMass {
        constructor(x, y, mass) {
          this.position = new Vector(x, y);
          this.prevPosition = new Vector(x, y);
          this.mass = mass;
        }

        applyForce(force) {
          this.position = this.position.add(force.div(this.mass));
        }

        integrate(dt) {
          let temp = this.position;
          this.position = this.position.add(this.position.sub(this.prevPosition));
          this.prevPosition = temp;
        }
      }

      class DistanceConstraint {
        constructor(pointA, pointB, restLength) {
          this.pointA = pointA;
          this.pointB = pointB;
          this.restLength = restLength;
        }

        solve() {
          let diff = this.pointB.position.sub(this.pointA.position);
          let dist = diff.mag();
          let error = dist - this.restLength;
          let correction = diff.mul(error / dist / 2);
          this.pointA.position = this.pointA.position.add(correction);
          this.pointB.position = this.pointB.position.sub(correction);
        }
      }

      const pivot = new PointMass(250, 250, 0);
      const bob = new PointMass(350, 250, 1);
      const string = new DistanceConstraint(pivot, bob, 100);

      renderer.loop((dt) => {
        renderer.clear();

        bob.applyForce(new Vector(0, 9.8)); // gravity
        bob.integrate(dt / 1000);
        string.solve();

        renderer.setFillColor("white");
        renderer.setStrokeColor("grey");
        renderer.circle(bob.position, 10); // bob
        // renderer.line(pivot.position.x, pivot.position.y, bob.position.x, bob.position.y); // string
      });
    </script>
  </body>
</html>
